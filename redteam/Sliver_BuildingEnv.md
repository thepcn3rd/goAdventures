
#### Table of Contents

[AWS Lightsail Configuration](Sliver_BuildingEnv.md#AWS_Lightsail_Configuration)

[Proxmox Configuration](Sliver_BuildingEnv.md#Proxmox_Configuration)

[Ansible Configuration](Sliver_BuildingEnv.md#Ansible_Configuration)



# AWS_Lightsail_Configuration

Often times people will use Terraform to deploy to AWS to automate provisioning.  I prefer for the educational projects that I create to use [AWS Lightsail](https://aws.amazon.com/free/compute/lightsail/).  This allows you to select a VM that has a set CPU, Memory, and disk space for an estimated monthly cost that is predictable.  

![buildingEnvironment_Platform.png](/redteam/images/buildingEnvironment_Platform.png)

![buildingEnvironment_plan.png](/redteam/images/buildingEnvironment_plan.png)

**SSH Keys** - When I provision a linux server in AWS Lightsail I will create and designate an SSH key for the specific project.  In the event I have to provide the SSH key, I am not compromising the default key.  I also may have multiple servers setup like a VPN server, Linux Web Server and a Sliver Server.  The SSH Key can allow only access to the Sliver Server if I create it correctly.

![buildingEnvironment_ChangeKeys.png](/redteam/images/buildingEnvironment_ChangeKeys.png)

**Network Setup (IP Addresses)** - With AWS Lightsail it provides 2 IP Addresses a publicly accessible IP Address and an internal routable IP Address.  Amongst all of the VMs created they can talk to each other by default with the internal routable IP Addresses.  You can establish individual server firewall policies to change the default configuration.  *I will disable IPv6 addresses that are setup*

![buildingEnvironment_IPs.png](/redteam/images/buildingEnvironment_IPs.png)

**Network Setup (Accessible Ports)** - By default the ports of SSH (TCP/22), HTTPS (TCP/443) and RDP (TCP/3389) are typically enabled by default.  These ports are open to the Public IP Address.  You can configure to only allow access from specific IP Addresses and then provision additional ports if needed.  

![buildingEnvironment_Firewall.png](/redteam/images/buildingEnvironment_Firewall.png)


# Proxmox_Configuration

I used a basic install of Proxmox to setup 2 Windows Server 2019 servers with trial licenses.  One server will be the domain controller and the other the connected member server.  My notes to get two servers setup to become a template are below.

1. After installation setup a password that is temporary
2. Configure a static IP address for any domain controllers
3. Configure the DNS server for any member servers to be the domain controller
4. Powershell to setup and configure ansible on Windows Server 2019  (Not recommended for production environments)
```
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
Invoke-WebRequest -Uri https://bit.ly/3p6diNf -UseBasicParsing -OutFile setupAnsible.ps1
```
5. After the execution of the above then execute the .\setupAnsible.ps1 script that is created.  The script should return with "Ok." if it completed successfully.
6. Because I am using a test environment, I disabled the Windows Firewall


# Ansible_Configuration

Ansible is an open-source IT automation platform that simplifies IT tasks and complex processes. It is agentless, which means it does not require installing software on managed nodes. Instead, it uses a simple language called YAML to define tasks and playbooks. Playbooks are a collection of tasks that can be automated and run as a single unit. (Generated by Bard)

Install Ansible
```bash
sudo pacman -S ansible
```

Install sshpass to communicate with Linux Servers
```bash
sudo pamac -S sshpass
```

Create the following directory structure...
```txt
ansible (Parent Directory)
ansible/roles
ansible/library
ansible/playbooks
ansible/keys (This is where I place any SSH keys used by ansible)
ansible/downloads (Programs that I install with ansible)
```

Create the following files with the contents modified as you need them for your projects...

ansible.cfg - Create in the ansible parent directory
```txt
[defaults]
nocows = 1
host_key_checking = False
deprecation_warnings = False
roles_path = ${PWD}/roles
library = ${PWD}/library
inventory = ${PWD}/inventory.yml

[inventory]
#enable_plugins = vmware_vm_inventory
#enable_plugins = vmware_vm_inventory, community.vmware.vmware_vm_info

[ssh_connection]
pipelining = True

[persistent_connection ]
command_timeout = 90
```

configure.yml - Create in the ansible parent directory
```txt
---
## Command that you execute to run the playbooks uncommented
# ansible-playbook -i inventory.yml configure.yml 
#
## Uncomment the playbook below that you want to execute
#- import_playbook: playbooks/configOpenVPN.yml
- import_playbook: playbooks/configSliverServer.yml
- import_playbook: playbooks/configSliverClient.yml
```

The playbook called configServer.yml is uncommented and would execute.  Add the playbooks above that you create for the project.

inventory.yml - Create in the ansible parent directory
```txt
all:
  hosts:
    sliverServer:
      ansible_host: "172.16.20.200"
      ansible_port: "22"
      ansible_connection: "ssh"
      ansible_user: "{{ commonUser }}"
      ansible_ssh_pass: "{{ commonPass }}" # Double curly bracket indicates a var
      ansible_become_password: "{{ commonPass }}"
    sliverClient:
      ansible_host: "172.16.20.106"
      ansible_port: "22"
      ansible_connection: "ssh"
      ansible_user: "username"
      ansible_ssh_key_file: "{{ sshPemKey }}"
    winDC:   # Assumes that ansible is already prepared on the windows box
      ansible_host: "172.16.20.180"
      ansible_port: "5986"
      ansible_connection: "winrm"
      ansible_user: "{{ commonWindowsAdminUser }}"
      ansible_password: "{{ commonWindowsAdminPass }}"
  vars:
    ansible_python_interpreter: /usr/bin/python3
    commonUser: "ubuntu"
    commonPass: "AStrongP@ssword"
    commonWindowsAdminUser: "Administrator"
    commonWindowsAdminPass: "ABadP@ssword"
    sshPemKey: "/home/location/ansible/keys/lightsail.pem"
    ansibleDirectory: "/home/user/ansible"
```

In the above config utilize the IP Addresses that are reachable by SSH.  If they exist in Lightsail you would use the public IP Address unless you have a connect to a machine that hosts ansible in Ligthsail, if that is the case then use the internal IP Address provided.

Notice that the sliverServer host uses an SSH password to authenticate, the become password is to escalate to a user that can install packages (sudo password).  To use the SSH key provided by lightsail you can see that under the sliverClient configuration.

Modify the ansible directory above to be where your ansible installation is located

run.sh - Build a simple execution script for running the playbooks
```bash
#!/bin/bash
#
ansible-playbook -i inventory.yml configure.yml
```

Here is an example of a playbook that I created to deploy Sliver to a dedicated server.  

ansible/playbooks/configSliverServer.yml
```yml
---
- name: Configure sliverC2 server for  Assessment
  hosts: sliverServer
  become: yes
  gather_facts: yes

  tasks:
    - set_fact:
        hostname: myLittlePwny

    - name: "Change the hostname to {{ hostname }}"
      hostname:
        name: "{{ hostname }}"

    # Sometimes does not work...
    - name: "apt Update packages"
      apt:
        update_cache: yes


    - name: "Install Dependencies for Sliver Server"
      apt:
        pkg:
          - curl
          - unzip
          - apt-transport-https
          - ca-certificates
          - software-properties-common
    
    - name: Create the Directory
      file:
        path: /home/{{ commonUser }}/binaries
        state: directory
        owner: "{{ commonUser }}"
        group: "{{ commonUser }}"
        mode: "0700"
    
    - name: Create the Directory
      file:
        path: "/home/{{ commonUser }}/msf"
        state: directory
        owner: "{{ commonUser }}"
        group: "{{ commonUser }}"
        mode: "0700"
    
    # curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall
    - name: Copy metasploit Install Script to the sliverServer
      ansible.builtin.copy:
        src: "{{ ansibleDirectory }}/downloads/msfinstall"
        dest: "/home/{{ commonUser }}/msf/msfinstall"
        owner: "{{ commonUser }}"
        group: "{{ commonUser }}"
        mode: '0700'

    - name: Install Metasploit
      command: "/home/{{ commonUser }}/msf/msfinstall"
      async: 600
      poll: 15

    - name: Create the Directory
      file:
        path: "/home/{{ commonUser }}/sliverServer"
        state: directory
        owner: "{{ commonUser }}"
        group: "{{ commonUser }}"
        mode: "0700"

    # curl https://sliver.sh/install -o sliverc2.sh to the downloads directory
    - name: Copy Sliver Install Script to the sliverServer
      ansible.builtin.copy:
        src: "{{ ansibleDirectory }}/downloads/sliverc2.sh"
        dest: "/home/{{ commonUser }}/sliverServer/sliverc2.sh"
        owner: "{{ commonUser }}"
        group: "{{ commonUser }}"
        mode: '0700'

    - name: Install the Sliver Server
      command: "/home/{{ commonUser }}/sliverServer/sliverc2.sh"
      async: 600
      poll: 15

    - name: Enable the Sliver Server Service
      systemd:
        name: sliver.service
        enabled: yes

```

Below is the playbook to copy the pre-compiled binary for sliver to a sliver client specified in the configure.yml file.

ansible/playbooks/configSliverClient.yml
```yml
---
- name: Configure sliverC2 client for Assessment PoC 
  hosts: sliverClient
  become: yes
  gather_facts: yes

  tasks:
    - set_fact:
        hostname: silverandgold

    # Sometimes does not work...
    - name: "apt Update packages"
      apt:
        update_cache: yes


    - name: "Install Dependencies for Sliver"
      apt:
        pkg:
          - curl
          - unzip
          - apt-transport-https
          - ca-certificates
          - software-properties-common
          - mingw-w64
          - binutils-mingw-w64
          - g++-mingw-w64

	# sliver-client_linux is downloaded as a precompiled binary
    - name: Copy Sliver Client to sliverClient/client
      ansible.builtin.copy:
        src: "{{ ansibleDirectory }}/downloads/sliver-client_linux"
        dest: /home/thepcn3rd/sliverClient
        mode: '0700'
        owner: thepcn3rd
        group: thepcn3rd

```

A couple of notes on configuring ansible to talk with Windows hosts.  Below is the configuration you can add to inventory.yml to allow ansible to talk with a Windows host.

+inventory.yml
```yml
   winserver:
      ## How to setup winrm: https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html
      # Powershell to execute on windows host
      # [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
      # Invoke-WebRequest -Uri https://bit.ly/3p6diNf -UseBasicParsing -OutFile setupAnsible.ps1
      ansible_host: "172.21.100.180"
      # Port NATed to WinRM HTTPS in pfSense Firewall
      ansible_port: "5986"
      ansible_user: "Administrator"
      ansible_password: "{{ commonPass }}"
      ansible_connection: "winrm"
      #ansible_winrm_transport: "basic"
      ansible_winrm_server_cert_validation: "ignore"
      ansible_winrm_scheme: "https"

```

In the notes of the above addition to inventory.yml you will notice that the ansible website references how to install it.  I created a bit.ly link to reference the install script that they provide for educational use environments.  Execute the following 2 lines on a windows host to configure for ansible:

```powershell
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
Invoke-WebRequest -Uri https://bit.ly/3p6diNf -UseBasicParsing -OutFile setupAnsible.ps1
.\setupAnsible.ps1
```

